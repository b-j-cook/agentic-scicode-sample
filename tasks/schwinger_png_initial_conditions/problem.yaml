# =============================================================================
# Task Definition
# =============================================================================


# TASK IDENTIFIER
# ---------------
problem_id: "schwinger_png_initial_conditions"

# DISPLAY NAME
# ------------
problem_name: "Schwinger reduced kernel PNG initial conditions (equilateral template)"

# DOMAIN
# ------
domain: "physics"

# Subdomain for organization
subdomain: "Computational Physics"


# =============================================================================
# PROBLEM DESCRIPTION
# =============================================================================

description: |
  Your task is to implement a small scale version of a primordial non-Gaussianity (PNG) initial conditions generator for cosmological simulations, inspired by the attached arXiv paper. 

  The primordial potential in Fourier space is modelled as 
  $$
  \Phi (\mathbf{k})=\Phi_G (\mathbf{k})+f_{\rm NL} \Phi_{\rm NG}(\mathbf{k})
  $$
  where $\Phi_G$ is a Gaussian random field with a prescribed power spectrum $P_\Phi (k)$, and $\Phi_{\rm NG}$ is a quadratic correction constructed so that (to leading order) the bispectrum of $\Phi$ matches a chosen template. 

  This task implements the reduced bispectrum kernel method and the key Schwinger parameter identity that rewrites a non-separable denominator into an integral over separable factors, enabling FFT-based acceleration on a discrete grid. 

  A complete solution would correctly:
  1) construct FFT-ordered $k$-grids;
  2) evaluate an analytic $P_\Phi (k)$ (with safe handling of $k=0$); 
  3) draw a deterministic Gaussian $\Phi_G (\mathbf{k})$;
  4) build a separable equilateral bispectrum decomposition (with 10 terms);
  5) calculate $\Phi_{\rm NG}(\mathbf{k})$ using Schwinger trapezoidal quadrature and FFT-based wrapped convolutions; and finally,
  6) orchestrate steps 1-5 to build $\Phi(\mathbf{k})$ end-to-end and estimate a binned bispectrum as a diagnostic on tiny grids. 


# =============================================================================
# I/O SPECIFICATION
# =============================================================================

io_spec: |
  """
  Schwinger reduced bispectrum kernel PNG initial conditions (equilateral template)
  
  Implements a miniature workflow to generate primordial non-Gaussianity initial conditions on a cubic periodic FFT grid, using a reduced bispectrum kernel and a Schwinger parameter separable reformulation.
  
  Parameters
  ----------
  N : int
      Grid size per dimension (N^3 Fourier modes).
  box_size : float
      Side length L of the cubic periodic box.
  A_s : float
      Amplitude of the analytic primordial potential power spectrum.
  n_s : float
      Spectral index of the analytic primordial potential power spectrum. 
  k_pivot : float
      Pivot scale for the analytic power spectrum. 
  seed : int
      RNG seed for deterministic generation of the Gaussian field Φ_G(k).
  f_NL : float
      PNG amplitude used in the final step to form Φ = Φ_G + F_NL Φ_NG
  Nt : int
      Number of Schwinger parameter samples for trapezoidal quadrature on  t ∈ [0,t_max].
  t_max : float or None
    The Upper limit of the Schwinger integral. If None, chosen from t_max_factor * max(P_Φ).
  t_max_factor : float
    The factor used to determine t_max, if t_max is None.
  k1, k2, k3 : float
    Target bin centers (magnitudes) for a binned bispectrum diagnostic.
  dk : float
    Bin width for the bispectrum diagnostic. 
  
  Returns
  -------
  Intermediate and final outputs given by the functions in different steps:
  - (kx,ky,kz,k_mag): np.ndarray
      FFT-ordered wavevector grids (output of the function in step 1). 
  - P_phi: np.ndarray
      Primordial potential power spectrum grid (output of the function in step 2). 
  - phiG_k: np.ndarray (complex)
      Gaussian potential Fourier coefficients (output of the function in step 3). 
  - (b1,b2,b3): (np.ndarray, np.ndarray, np.ndarray)
      Separable equilateral bispectrum factors (10 terms, output of the function in step 4).
  - phiNG_k: np.ndarray (complex)
      Non-Gaussian correction Fourier coefficients (output of the function in step 5). 
  - (B_hat, N_tri): (complex, int)
      Binned bispectrum diagnostic and triangle count (output of the function in the final step). 
  
  Units
  -----
   - k components and magnitudes are in radians / length.
   - P_Φ has arbitrary units consistent with the analytic model in step 2. 

  """


# =============================================================================
# DEPENDENCIES
# =============================================================================

dependencies:
  - import numpy as np
  - from typing import Tuple, Optional


# =============================================================================
# STEPS
# =============================================================================

steps:
  - 01_kgrid_3d
  - 02_primordial_power_spectrum
  - 03_gaussian_potential_fourier
  - 04_equilateral_bispectrum_factors
  - 05_phi_ng_schwinger
  - 06_bispectrum_binned_estimator

# =============================================================================
# BACKGROUND (OPTIONAL)
# =============================================================================

background_main: |
  This task is based on the reduced bispectrum kernel PNG construction, where the quadratic convolution kernel is given by:
  $$
  W(K_1,K_2,K_3) = \frac{B_\Phi(K_1,K_2,K_3)}{2 f_{\rm NL} [P_1 P_2+ P_2 P_3 + P_1 P_3]}.
  $$

  The Schwinger parameter identity rewrites the non-separable denominator as
  $$
  \frac{1}{P_1P_2 + P_2P_3 + P_1P_3}= \int_0^{\infty} dt \frac{e^{-t/P_1}}{P_1} \frac{e^{-t/P_2}}{P_2} \frac{e^{-t/P_3}}{P_3}.
  $$

  For a separable bispectrum template
  $$
  \bar B(k_1,k_2,k_3) = \frac{B_\Phi(k_1,k_2,k_3)}{2 f_{\rm NL}} = \sum_i b_{1,i}(k_1) b_{2,i}(k_2) b_{3,i}(k_3),
  $$
  the Schwinger integral turns the computation of $\Phi_{\rm NG}(\mathbf{k})$ into a sum of FFT-based wrapped convolutions per t-sample, which is what you implement here.
